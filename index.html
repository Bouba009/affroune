<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Affroun Online - Ø§Ù„Ø¹ÙØ±ÙˆÙ† Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ================= CSS VARIABLES & RESET ================= */
        :root {
            --primary: #f97316; /* Ouedkniss-like Orange */
            --secondary: #1e293b;
            --bg: #f3f4f6;
            --white: #ffffff;
            --gold: #fef08a;
            --gold-border: #eab308;
            --text-dark: #111827;
            --text-light: #6b7280;
            --font-ar: 'Tajawal', sans-serif;
            --font-fr: 'Poppins', sans-serif;
            --transition: all 0.3s ease;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-ar); background: var(--bg); color: var(--text-dark); overflow-x: hidden; }
        html body { font-family: var(--font-fr); }
        html body { font-family: var(--font-ar); }
        a { text-decoration: none; color: inherit; }
        button { cursor: pointer; border: none; outline: none; font-family: inherit; }
        ul { list-style: none; }
        .hidden { display: none !important; }

        /* ================= HEADER & NAV ================= */
        header { background: var(--white); box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .nav-container { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; max-width: 1200px; margin: 0 auto; }
        .logo { font-size: 22px; font-weight: 900; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .logo img { max-height: 40px; border-radius: 8px; }
        .header-actions { display: flex; align-items: center; gap: 15px; }
        .btn-icon { background: none; font-size: 20px; color: var(--secondary); transition: var(--transition); }
        .btn-icon:hover { color: var(--primary); transform: scale(1.1); }
        .btn-primary { background: var(--primary); color: var(--white); padding: 8px 15px; border-radius: 20px; font-weight: bold; transition: var(--transition); font-size: 14px;}
        .btn-primary:hover { background: #ea580c; }

        /* ================= SIDEBAR ================= */
        .sidebar { position: fixed; top: 0; right: -300px; width: 280px; height: 100vh; background: var(--white); box-shadow: -5px 0 15px rgba(0,0,0,0.1); z-index: 1000; transition: var(--transition); padding: 20px; overflow-y: auto;}
        html .sidebar { right: auto; left: -300px; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
        .sidebar.active { right: 0; }
        html .sidebar.active { left: 0; }
        .close-sidebar { position: absolute; top: 20px; left: 20px; font-size: 24px; color: var(--text-dark); background: none; }
        html .close-sidebar { left: auto; right: 20px; }
        .sidebar ul { margin-top: 50px; }
        .sidebar ul li { padding: 15px 0; border-bottom: 1px solid #eee; font-weight: 500; cursor: pointer; transition: var(--transition); display:flex; gap:10px; align-items:center;}
        .sidebar ul li:hover { color: var(--primary); padding-right: 10px; }
        html .sidebar ul li:hover { padding-right: 0; padding-left: 10px; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: none; }

        /* ================= MAIN BANNER ================= */
        .slider-container { width: 100%; max-width: 1200px; margin: 10px auto; height: 180px; background: #ddd; border-radius: 10px; overflow: hidden; position: relative; }
        .slider-container img { width: 100%; height: 100%; object-fit: cover; }
        @media (min-width: 768px) { .slider-container { height: 350px; } }

        /* ================= CATEGORIES SLIDER (REAL IMAGES) ================= */
        .categories-container { max-width: 1200px; margin: 15px auto; position: relative; background: var(--white); padding: 15px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .categories-wrapper { display: flex; overflow-x: auto; padding: 0 15px; gap: 15px; scroll-snap-type: x mandatory; scrollbar-width: none; -ms-overflow-style: none; scroll-behavior: smooth; }
        .categories-wrapper::-webkit-scrollbar { display: none; }
        .category-item { flex: 0 0 calc(25% - 15px); min-width: 85px; max-width: 110px; display: flex; flex-direction: column; align-items: center; gap: 8px; scroll-snap-align: start; cursor: pointer; transition: var(--transition); }
        .category-item img { width: 75px; height: 75px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); padding: 3px; background: var(--white); box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: var(--transition); }
        .category-item:hover img { transform: scale(1.08); border-color: var(--secondary); }
        .category-item span { font-size: 12px; font-weight: 700; text-align: center; color: var(--secondary); white-space: normal; line-height: 1.3; }
        @media (min-width: 768px) { .category-item { flex: 0 0 calc(12.5% - 15px); } }

        /* ================= ADS GRID ================= */
        .ads-section { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .section-title { font-size: 20px; font-weight: bold; margin-bottom: 15px; color: var(--secondary); display: flex; align-items: center; gap: 10px; border-bottom: 2px solid #eee; padding-bottom: 10px;}
        .ads-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        @media (min-width: 768px) { .ads-grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); } }
        
        .ad-card { background: var(--white); border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: var(--transition); cursor: pointer; position: relative; border: 1px solid #eee;}
        .ad-card:hover { box-shadow: 0 8px 20px rgba(0,0,0,0.15); transform: translateY(-3px); border-color: var(--primary);}
        .ad-img { width: 100%; height: 160px; object-fit: cover; }
        .ad-content { padding: 12px; }
        .ad-title { font-size: 14px; font-weight: bold; color: var(--secondary); margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ad-price { color: var(--primary); font-weight: 900; font-size: 16px; margin-bottom: 5px; }
        .ad-meta { font-size: 11px; color: var(--text-light); display: flex; justify-content: space-between; align-items:center; }
        
        .ad-featured { background: linear-gradient(135deg, #fffbeb, #fef08a); border: 1px solid var(--gold-border); }
        .featured-badge { position: absolute; top: 10px; right: 10px; color: var(--primary); background: rgba(255,255,255,0.95); width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10; animation: pulse 2s infinite; font-size:12px;}
        html .featured-badge { right: auto; left: 10px; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }

        /* ================= FLOATING BUTTONS ================= */
        .fab-container { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 15px; z-index: 900; opacity: 0.5; transition: var(--transition); }
        html .fab-container { right: auto; left: 30px; }
        .fab-container:hover, .fab-container:active { opacity: 1; }
        .fab { width: 55px; height: 55px; border-radius: 50%; background: var(--primary); color: var(--white); font-size: 22px; display: flex; justify-content: center; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: var(--transition); }
        .fab.filter { background: var(--secondary); }
        .fab:hover { transform: scale(1.1) translateY(-5px); }

        /* ================= MODALS & FORMS ================= */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: var(--transition); backdrop-filter: blur(5px); }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: var(--white); width: 90%; max-width: 500px; border-radius: 15px; padding: 25px; position: relative; max-height: 90vh; overflow-y: auto; transform: translateY(-50px); transition: var(--transition); }
        .modal.active .modal-content { transform: translateY(0); }
        .close-modal { position: absolute; top: 15px; left: 15px; font-size: 20px; background: none; color: var(--text-light); }
        html .close-modal { left: auto; right: 15px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; color: var(--secondary);}
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 14px; background:#fafafa;}
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--primary); outline: none; background:var(--white);}
        .btn-submit { width: 100%; background: var(--primary); color: var(--white); padding: 14px; border-radius: 8px; font-size: 16px; font-weight: bold; margin-top: 10px; transition:var(--transition); box-shadow: 0 4px 10px rgba(249, 115, 22, 0.3);}
        .btn-submit:hover { background: #ea580c; }

        /* ================= AD DETAILS VIEW ================= */
        .ad-detail-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--white); z-index: 1500; overflow-y: auto; transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        html .ad-detail-page { transform: translateX(-100%); }
        .ad-detail-page.active { transform: translateX(0); }
        .ad-detail-header { padding: 15px 20px; background: var(--white); box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px; position: sticky; top: 0; z-index:10;}
        .ad-detail-img { width: 100%; height: 350px; object-fit: contain; background: #000; }
        .ad-detail-info { padding: 20px; max-width: 800px; margin: 0 auto; padding-bottom:100px;}
        .ad-detail-price { color: var(--primary); font-size: 26px; font-weight: 900; margin: 10px 0; }
        .ad-actions { display: flex; gap: 10px; position: fixed; bottom: 0; left:0; width:100%; padding: 15px 20px; background:var(--white); box-shadow: 0 -2px 10px rgba(0,0,0,0.1); justify-content:center;}
        .ad-actions-inner { display:flex; gap:10px; width:100%; max-width:800px;}
        .btn-call { flex: 1; background: #22c55e; color: white; padding: 15px; border-radius: 10px; font-size: 16px; font-weight: bold; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .btn-msg { flex: 1; background: var(--secondary); color: white; padding: 15px; border-radius: 10px; font-size: 16px; font-weight: bold; display: flex; justify-content: center; align-items: center; gap: 10px; }

        /* ================= FOOTER & ADMIN LOCK ================= */
        footer { background: var(--secondary); color: var(--white); padding: 40px 20px; text-align: center; margin-top: 50px; position: relative; }
        .footer-links { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 20px; font-size: 14px; }
        .footer-links a:hover { color: var(--primary); }
        .admin-lock { position: absolute; bottom: 10px; right: 10px; font-size: 14px; cursor: pointer; opacity: 0.1; transition:var(--transition);}
        .admin-lock:hover { opacity: 1; }

        /* ================= ADMIN DASHBOARD ================= */
        #admin-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 3000; overflow-y: auto; display: none; padding: 20px; }
        .admin-header { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; background:white; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05);}
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { padding: 20px; border-radius: 15px; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .c-1 { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .c-2 { background: linear-gradient(135deg, #10b981, #059669); }
        .c-3 { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .c-4 { background: linear-gradient(135deg, #8b5cf6, #6d28d9); }
        .admin-section { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; display: none;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- OVERLAY -->
    <div class="overlay" id="overlay" onclick="closeAllModals()"></div>

    <!-- HEADER -->
    <header>
        <div class="nav-container">
            <div class="logo" id="site-logo">
                <i class="fa-solid fa-store"></i> <span id="site-name">Ø§Ù„Ø¹ÙØ±ÙˆÙ† Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</span>
            </div>
            <div class="header-actions">
                <button class="btn-icon" id="lang-toggle" style="font-weight:bold; border:1px solid #ccc; padding:2px 8px; border-radius:5px; font-size:14px;">FR</button>
                <button class="btn-icon hidden" id="msg-icon" onclick="alert('Ù‚Ø³Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±')"><i class="fa-regular fa-comment-dots"></i></button>
                <button class="btn-primary" id="login-btn" onclick="openModal('login-modal')"><i class="fa-solid fa-user"></i> <span class="t-login">Ø¯Ø®ÙˆÙ„</span></button>
                <button class="btn-icon" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
            </div>
        </div>
    </header>

    <!-- SIDEBAR -->
    <nav class="sidebar" id="sidebar">
        <button class="close-sidebar" onclick="toggleSidebar()"><i class="fa-solid fa-times"></i></button>
        <ul>
            <li onclick="goHome()"><i class="fa-solid fa-home"></i> <span class="t-home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></li>
            <li onclick="openPage('privacy')"><i class="fa-solid fa-shield-halved"></i> <span class="t-privacy">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</span></li>
            <li onclick="openPage('about')"><i class="fa-solid fa-circle-info"></i> <span class="t-about">Ù…Ù† Ù†Ø­Ù†</span></li>
            <li onclick="openPage('contact')"><i class="fa-solid fa-envelope"></i> <span class="t-contact">Ø§ØªØµÙ„ Ø¨Ù†Ø§</span></li>
            <li onclick="openModal('report-modal')"><i class="fa-solid fa-triangle-exclamation"></i> <span class="t-report">Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©</span></li>
            <li id="logout-li" class="hidden" onclick="logout()" style="color: red; margin-top:20px;"><i class="fa-solid fa-arrow-right-from-bracket"></i> <span class="t-logout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</span></li>
        </ul>
    </nav>

    <!-- MAIN CONTENT -->
    <main id="main-view">
        <!-- Banner Slider -->
        <div class="slider-container" id="banner-slider">
            <img src="https://images.unsplash.com/photo-1555529771-835f59fc5efe?auto=format&fit=crop&w=1200&q=80" alt="Banner" id="main-banner-img">
        </div>

        <!-- HTML Ads Injection Space -->
        <div id="injected-ads" style="text-align:center; margin:10px auto; max-width:1200px;"></div>

        <!-- Categories Slider (4 Circles) -->
        <div class="categories-container">
            <div class="categories-wrapper" id="categories-container">
                <!-- Rendered by JS -->
            </div>
        </div>

        <!-- Featured Ads -->
        <section class="ads-section">
            <h2 class="section-title"><i class="fa-solid fa-star" style="color: var(--gold-border);"></i> <span class="t-featured">Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ù…ÙŠØ²Ø©</span></h2>
            <div class="loader" id="loader-featured"></div>
            <div class="ads-grid" id="featured-ads-grid"></div>
        </section>

        <!-- All Ads -->
        <section class="ads-section">
            <h2 class="section-title"><i class="fa-solid fa-list" style="color: var(--primary);"></i> <span class="t-latest">Ø£Ø­Ø¯Ø« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</span></h2>
            <div class="loader" id="loader-latest"></div>
            <div class="ads-grid" id="latest-ads-grid"></div>
        </section>
    </main>

    <!-- FLOATING ACTION BUTTONS -->
    <div class="fab-container">
        <button class="fab filter" onclick="openModal('filter-modal')" title="ÙÙ„ØªØ±Ø©"><i class="fa-solid fa-filter"></i></button>
        <button class="fab" onclick="checkAuthAndPublish()" title="Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†"><i class="fa-solid fa-plus"></i></button>
    </div>

    <!-- ================= MODALS ================= -->

    <!-- Login/Signup Modal -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('login-modal')"><i class="fa-solid fa-times"></i></button>
            <h2 style="margin-bottom: 20px;" class="t-login-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h2>
            <div id="signup-fields" class="hidden">
                <div class="form-group">
                    <label class="t-name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input type="text" id="auth-name" placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label class="t-phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <input type="tel" id="auth-phone" placeholder="0555000000">
                </div>
            </div>
            <div class="form-group">
                <label class="t-email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                <input type="email" id="auth-email" placeholder="email@example.com">
            </div>
            <div class="form-group">
                <label class="t-password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" id="auth-password" placeholder="******">
            </div>
            <button class="btn-submit" onclick="handleLogin()" id="btn-do-login">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            <button class="btn-submit" style="background:var(--secondary); margin-top:10px;" onclick="toggleSignup()" id="btn-do-signup">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
        </div>
    </div>

    <!-- Publish Modal -->
    <div class="modal" id="publish-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('publish-modal')"><i class="fa-solid fa-times"></i></button>
            <h2 style="margin-bottom: 20px;" class="t-publish">Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯</h2>
            <div class="form-group"><label class="t-ad-title">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ / Ø§Ù„Ø®Ø¯Ù…Ø©</label><input type="text" id="pub-title"></div>
            <div class="form-group"><label class="t-ad-desc">Ø§Ù„ÙˆØµÙ</label><textarea id="pub-desc" rows="3"></textarea></div>
            <div class="form-group"><label class="t-ad-price">Ø§Ù„Ø³Ø¹Ø± (Ø¯Ø¬)</label><input type="number" id="pub-price"></div>
            <div class="form-group"><label class="t-category">Ø§Ù„ÙØ¦Ø©</label><select id="pub-category"></select></div>
            <div class="form-group">
                <label class="t-condition">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                <select id="pub-condition">
                    <option value="none" class="t-cond-none">Ù„Ø§ Ø´ÙŠØ¡ (Ù„Ø§ ØªØ¸Ù‡Ø±)</option>
                    <option value="new" class="t-cond-new">Ø¬Ø¯ÙŠØ¯Ø©</option>
                    <option value="used" class="t-cond-used">Ù…Ø³ØªØ¹Ù…Ù„Ø©</option>
                </select>
            </div>
            <div class="form-group"><label class="t-city">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label><select id="pub-city"></select></div>
            <div class="form-group"><label class="t-image">Ø§Ù„ØµÙˆØ±Ø© (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)</label><input type="file" id="pub-image" accept="image/*"></div>
            <button class="btn-submit" onclick="submitAd()" id="btn-submit-ad">Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
        </div>
    </div>

    <!-- Filter Modal -->
    <div class="modal" id="filter-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('filter-modal')"><i class="fa-solid fa-times"></i></button>
            <h2 style="margin-bottom: 20px;" class="t-filter">ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨Ø­Ø«</h2>
            <div class="form-group"><label class="t-search">ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø­Ø«</label><input type="text" id="fil-search"></div>
            <div class="form-group"><label class="t-category">Ø§Ù„ÙØ¦Ø©</label><select id="fil-category"><option value="">Ø§Ù„ÙƒÙ„</option></select></div>
            <div class="form-group"><label class="t-city">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label><select id="fil-city"><option value="">Ø§Ù„ÙƒÙ„</option></select></div>
            <div class="form-group"><label class="t-max-price">Ø£Ù‚ØµÙ‰ Ø³Ø¹Ø±</label><input type="number" id="fil-price" placeholder="Ù…Ø«Ø§Ù„: 50000"></div>
            <button class="btn-submit" onclick="applyFilter()" class="t-apply">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±</button>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal" id="report-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('report-modal')"><i class="fa-solid fa-times"></i></button>
            <h2 style="margin-bottom: 20px;" class="t-report">Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©</h2>
            <div class="form-group"><label class="t-name">Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="rep-name"></div>
            <div class="form-group"><label class="t-email">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label><input type="email" id="rep-email"></div>
            <div class="form-group"><label class="t-ad-desc">Ø§Ù„ÙˆØµÙ</label><textarea id="rep-desc" rows="4"></textarea></div>
            <button class="btn-submit" onclick="submitReport()">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>
    </div>

    <!-- Generic Page Modal -->
    <div class="modal" id="page-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('page-modal')"><i class="fa-solid fa-times"></i></button>
            <h2 id="page-title" style="margin-bottom: 20px; color:var(--primary);"></h2>
            <div id="page-content" style="line-height: 1.8; font-size: 15px; color:var(--secondary); white-space:pre-wrap;"></div>
        </div>
    </div>

    <!-- ================= AD DETAILS PAGE ================= -->
    <div class="ad-detail-page" id="ad-detail-page">
        <div class="ad-detail-header">
            <button class="btn-icon" onclick="closeAdDetail()"><i class="fa-solid fa-arrow-right" id="back-icon"></i></button>
            <span style="font-weight:bold; font-size:18px;" class="t-ad-details">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</span>
        </div>
        <img src="" id="det-img" class="ad-detail-img">
        <div class="ad-detail-info">
            <h1 id="det-title" style="font-size: 24px; color:var(--secondary); margin-bottom:5px;"></h1>
            <div class="ad-meta" style="margin: 10px 0; font-size: 14px; border-bottom:1px solid #eee; padding-bottom:15px;">
                <span id="det-city"><i class="fa-solid fa-location-dot"></i> </span>
                <span id="det-user" style="margin:0 15px;"><i class="fa-solid fa-user"></i> </span>
            </div>
            <div class="ad-detail-price" id="det-price"></div>
            <div id="det-condition" style="display:inline-block; padding:5px 12px; background:var(--primary); color:white; border-radius:20px; font-size:12px; font-weight:bold; margin-bottom:20px;"></div>
            <h3 style="margin-bottom: 10px; color:var(--secondary);" class="t-ad-desc">Ø§Ù„ÙˆØµÙ</h3>
            <p id="det-desc" style="white-space: pre-wrap; color: var(--text-light); line-height: 1.8; font-size:15px; background:#fafafa; padding:15px; border-radius:10px; border:1px solid #eee;"></p>
        </div>
        <div class="ad-actions">
            <div class="ad-actions-inner">
                <button class="btn-call" onclick="showPhone()"><i class="fa-solid fa-phone"></i> <span id="phone-text" class="t-call">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</span></button>
                <button class="btn-msg" onclick="initiateMessage()"><i class="fa-solid fa-paper-plane"></i> <span class="t-msg">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©</span></button>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer>
        <div class="footer-links">
            <a href="#" onclick="goHome()" class="t-home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            <a href="#" onclick="openPage('privacy')" class="t-privacy">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a>
            <a href="#" onclick="openPage('about')" class="t-about">Ù…Ù† Ù†Ø­Ù†</a>
            <a href="#" onclick="openPage('contact')" class="t-contact">Ø§ØªØµÙ„ Ø¨Ù†Ø§</a>
        </div>
        <p>&copy; 2026 El Affroun Online. All rights reserved.</p>
        <div class="admin-lock" onclick="promptAdmin()">ğŸ”’</div>
    </footer>

    <!-- ================= ADMIN DASHBOARD ================= -->
    <div id="admin-panel">
        <div class="admin-header">
            <h2 style="color:var(--secondary);"><i class="fa-solid fa-user-shield"></i> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
            <button class="btn-primary" style="background:#ef4444;" onclick="exitAdmin()">Ø®Ø±ÙˆØ¬</button>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card c-1"><h3>Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3><h2 id="st-daily">0</h2></div>
            <div class="stat-card c-2"><h3>Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø´Ù‡Ø±</h3><h2 id="st-monthly">0</h2></div>
            <div class="stat-card c-3"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</h3><h2 id="st-ads">0</h2></div>
            <div class="stat-card c-4"><h3>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3><h2 id="st-users">0</h2></div>
        </div>

        <div class="admin-section">
            <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</h3>
            <input type="text" id="adm-search-ad" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¥Ø¹Ù„Ø§Ù† Ø¨Ø§Ù„Ø§Ø³Ù…..." style="width:100%; padding:10px; margin:10px 0; border:1px solid #ccc; border-radius:5px;">
            <div id="adm-ads-list" style="max-height: 300px; overflow-y:auto; border:1px solid #eee; border-radius:5px;"></div>
        </div>

        <div class="admin-section">
            <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
            <input type="text" id="adm-search-user" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„..." style="width:100%; padding:10px; margin:10px 0; border:1px solid #ccc; border-radius:5px;">
            <div id="adm-users-list" style="max-height: 250px; overflow-y:auto; border:1px solid #eee; border-radius:5px;"></div>
        </div>

        <div class="admin-section">
            <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ø© (ØªÙØ­ÙØ¸ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ)</h3>
            <div class="form-group"><label>Ù†Øµ Ø§Ù„Ù„ÙˆØºÙˆ</label><input type="text" id="adm-logo-text" value="Ø§Ù„Ø¹ÙØ±ÙˆÙ† Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†"></div>
            <div class="form-group"><label>Ø±Ø§Ø¨Ø· Ø§Ù„Ù„ÙˆØºÙˆ (ØµÙˆØ±Ø© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©)</label><input type="text" id="adm-logo-img" placeholder="https://..."></div>
            <div class="form-group"><label>Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø§Ù†Ø± (Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø±)</label><input type="text" id="adm-banner-url"></div>
            <div class="form-group"><label>ÙƒÙˆØ¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª HTML (ØªØ¸Ù‡Ø± ØªØ­Øª Ø§Ù„Ø¨Ø§Ù†Ø±)</label><textarea id="adm-ads-code" rows="3" placeholder="<div...>Ads</div>"></textarea></div>
            
            <h4 style="margin-top:20px; color:var(--primary);">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ©</h4>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div class="form-group"><label>Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ© (Ø¹Ø±Ø¨ÙŠ)</label><textarea id="adm-priv-ar" rows="3"></textarea></div>
                <div class="form-group"><label>Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ© (ÙØ±Ù†Ø³ÙŠ)</label><textarea id="adm-priv-fr" rows="3"></textarea></div>
                <div class="form-group"><label>Ù…Ù† Ù†Ø­Ù† (Ø¹Ø±Ø¨ÙŠ)</label><textarea id="adm-abt-ar" rows="3"></textarea></div>
                <div class="form-group"><label>Ù…Ù† Ù†Ø­Ù† (ÙØ±Ù†Ø³ÙŠ)</label><textarea id="adm-abt-fr" rows="3"></textarea></div>
                <div class="form-group"><label>Ø§ØªØµÙ„ Ø¨Ù†Ø§ (Ø¹Ø±Ø¨ÙŠ)</label><textarea id="adm-cnt-ar" rows="3"></textarea></div>
                <div class="form-group"><label>Ø§ØªØµÙ„ Ø¨Ù†Ø§ (ÙØ±Ù†Ø³ÙŠ)</label><textarea id="adm-cnt-fr" rows="3"></textarea></div>
            </div>
            
            <button class="btn-submit" onclick="saveAdminSettings()">Ø­ÙØ¸ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>

        <div class="admin-section">
            <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¨Ù„Ø§ØºØ§Øª</h3>
            <div id="adm-reports-list" style="max-height: 200px; overflow-y:auto; border:1px solid #eee; padding:10px; border-radius:5px;"></div>
        </div>
    </div>


    <!-- ================= JAVASCRIPT & FIREBASE ================= -->
    <script type="module">
        // --- FIREBASE INITIALIZATION ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, updateDoc, doc, deleteDoc, serverTimestamp, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDXdDA6rH50zAv5pmZKRkXnqosoFnC3GjY",
            authDomain: "filahadz-31183.firebaseapp.com",
            databaseURL: "https://filahadz-31183-default-rtdb.firebaseio.com",
            projectId: "filahadz-31183",
            storageBucket: "filahadz-31183.firebasestorage.app",
            messagingSenderId: "703541527613",
            appId: "1:703541527613:web:7d3af803ba09c894d4d654",
            measurementId: "G-BQC5Q4Q16M"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- GLOBAL STATE ---
        let currentLang = localStorage.getItem('lang') || 'ar';
        let currentUser = null;
        let currentUserData = null;
        let allAds = [];
        let allUsers =[];
        let isSignupMode = false;
        
        let siteSettings = {
            pages: { privacy: {ar:"",fr:""}, about: {ar:"",fr:""}, contact: {ar:"",fr:""} }
        };

        // --- DATA DICTIONARIES ---
        const cities =;
        
        // Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„ØªÙŠ Ø·Ù„Ø¨ØªÙ‡Ø§ Ø¨Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„ØºØªÙŠÙ† + ØµÙˆØ± Unsplash Ø­Ù‚ÙŠÙ‚ÙŠØ©
        const cats =;

        const translations = {
            ar: {
                login: "Ø¯Ø®ÙˆÙ„", home: "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", privacy: "Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©", about: "Ù…Ù† Ù†Ø­Ù†", contact: "Ø§ØªØµÙ„ Ø¨Ù†Ø§", report: "Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©",
                featured: "Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ù…ÙŠØ²Ø©", latest: "Ø£Ø­Ø¯Ø« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª", logout: "ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬", publish: "Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø¬Ø¯ÙŠØ¯",
                adTitle: "Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ / Ø§Ù„Ø®Ø¯Ù…Ø©", adDesc: "Ø§Ù„ÙˆØµÙ", adPrice: "Ø§Ù„Ø³Ø¹Ø± (Ø¯Ø¬)", category: "Ø§Ù„ÙØ¦Ø©", condition: "Ø§Ù„Ø­Ø§Ù„Ø©", city: "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©", image: "Ø§Ù„ØµÙˆØ±Ø© (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)",
                filter: "ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨Ø­Ø«", search: "ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø­Ø«", maxPrice: "Ø£Ù‚ØµÙ‰ Ø³Ø¹Ø±", apply: "ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±", call: "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ", msg: "Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©", adDetails: "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†",
                name: "Ø§Ù„Ø§Ø³Ù…", phone: "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ", email: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", password: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
                condNone: "Ù„Ø§ Ø´ÙŠØ¡ (Ù„Ø§ ØªØ¸Ù‡Ø±)", condNew: "Ø¬Ø¯ÙŠØ¯Ø©", condUsed: "Ù…Ø³ØªØ¹Ù…Ù„Ø©", currency: "Ø¯Ø¬", all: "Ø§Ù„ÙƒÙ„"
            },
            fr: {
                login: "Connexion", home: "Accueil", privacy: "ConfidentialitÃ©", about: "Ã€ propos", contact: "Contact", report: "Signaler",
                featured: "Annonces Ã  la Une", latest: "DerniÃ¨res Annonces", logout: "DÃ©connexion", publish: "Publier une annonce",
                adTitle: "Titre", adDesc: "Description", adPrice: "Prix (DA)", category: "CatÃ©gorie", condition: "Ã‰tat", city: "Ville", image: "Image (Obligatoire)",
                filter: "Filtrer", search: "Recherche", maxPrice: "Prix Max", apply: "Appliquer", call: "Appeler", msg: "Message", adDetails: "DÃ©tails de l'annonce",
                name: "Nom", phone: "TÃ©lÃ©phone", email: "Email", password: "Mot de passe",
                condNone: "Aucun", condNew: "Neuf", condUsed: "Occasion", currency: "DA", all: "Tous"
            }
        };

        // --- UTILS & CORE DOM FUNCTIONS ---
        window.q = (sel) => document.querySelector(sel);
        window.qa = (sel) => document.querySelectorAll(sel);
        
        window.openModal = (id) => {
            q('#overlay').style.display = 'block';
            q(`#${id}`).classList.add('active');
        };
        window.closeModal = (id) => {
            q('#overlay').style.display = 'none';
            q(`#${id}`).classList.remove('active');
        };
        window.closeAllModals = () => {
            qa('.modal').forEach(m => m.classList.remove('active'));
            q('#overlay').style.display = 'none';
            if(q('#sidebar').classList.contains('active')) toggleSidebar();
        };
        window.toggleSidebar = () => {
            const sb = q('#sidebar');
            sb.classList.toggle('active');
            q('#overlay').style.display = sb.classList.contains('active') ? 'block' : 'none';
        };
        window.goHome = () => { q('#sidebar').classList.remove('active'); q('#overlay').style.display='none'; closeAdDetail(); };

        // --- I18N (LANGUAGE) ---
        function applyLanguage() {
            document.documentElement.lang = currentLang;
            document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            q('#lang-toggle').innerText = currentLang === 'ar' ? 'FR' : 'AR';
            q('#back-icon').className = currentLang === 'ar' ? 'fa-solid fa-arrow-right' : 'fa-solid fa-arrow-left';
            
            const t = translations;
            qa('.t-login').forEach(el => el.innerText = currentUser ? currentUser.email.split('@') : t.login);
            qa('.t-home').forEach(el => el.innerText = t.home);
            qa('.t-privacy').forEach(el => el.innerText = t.privacy);
            qa('.t-about').forEach(el => el.innerText = t.about);
            qa('.t-contact').forEach(el => el.innerText = t.contact);
            qa('.t-report').forEach(el => el.innerText = t.report);
            qa('.t-featured').forEach(el => el.innerText = t.featured);
            qa('.t-latest').forEach(el => el.innerText = t.latest);
            qa('.t-logout').forEach(el => el.innerText = t.logout);
            qa('.t-publish').forEach(el => el.innerText = t.publish);
            qa('.t-ad-title').forEach(el => el.innerText = t.adTitle);
            qa('.t-ad-desc').forEach(el => el.innerText = t.adDesc);
            qa('.t-ad-price').forEach(el => el.innerText = t.adPrice);
            qa('.t-category').forEach(el => el.innerText = t.category);
            qa('.t-condition').forEach(el => el.innerText = t.condition);
            qa('.t-city').forEach(el => el.innerText = t.city);
            qa('.t-image').forEach(el => el.innerText = t.image);
            qa('.t-filter').forEach(el => el.innerText = t.filter);
            qa('.t-search').forEach(el => el.innerText = t.search);
            qa('.t-max-price').forEach(el => el.innerText = t.maxPrice);
            qa('.t-apply').forEach(el => el.innerText = t.apply);
            qa('.t-call').forEach(el => el.innerText = t.call);
            qa('.t-msg').forEach(el => el.innerText = t.msg);
            qa('.t-ad-details').forEach(el => el.innerText = t.adDetails);
            qa('.t-name').forEach(el => el.innerText = t.name);
            qa('.t-phone').forEach(el => el.innerText = t.phone);
            qa('.t-email').forEach(el => el.innerText = t.email);
            qa('.t-password').forEach(el => el.innerText = t.password);
            
            q('.t-cond-none').innerText = t.condNone;
            q('.t-cond-new').innerText = t.condNew;
            q('.t-cond-used').innerText = t.condUsed;

            renderCategories();
            renderSelects();
            renderAdsList(); 
        }

        q('#lang-toggle').addEventListener('click', () => {
            currentLang = currentLang === 'ar' ? 'fr' : 'ar';
            localStorage.setItem('lang', currentLang);
            applyLanguage();
        });

        // --- RENDER UI ---
        function renderCategories() {
            const container = q('#categories-container');
            container.innerHTML = '';
            cats.forEach(c => {
                const catName = currentLang === 'ar' ? c.ar : c.fr;
                const div = document.createElement('div');
                div.className = 'category-item';
                div.onclick = () => { q('#fil-category').value = c.id; applyFilter(); };
                div.innerHTML = `<img src="${c.img}" alt="${catName}"><span>${catName}</span>`;
                container.appendChild(div);
            });
        }

        function renderSelects() {
            const t = translations;
            const cityOpts = cities.map(c => `<option value="${c.id}">${currentLang === 'ar' ? c.ar : c.fr}</option>`).join('');
            const catOpts = cats.map(c => `<option value="${c.id}">${currentLang === 'ar' ? c.ar : c.fr}</option>`).join('');
            
            q('#pub-city').innerHTML = cityOpts;
            q('#fil-city').innerHTML = `<option value="">${t.all}</option>` + cityOpts;
            
            q('#pub-category').innerHTML = catOpts;
            q('#fil-category').innerHTML = `<option value="">${t.all}</option>` + catOpts;
        }

        function getCityName(id) {
            const c = cities.find(x => x.id === id);
            return c ? (currentLang === 'ar' ? c.ar : c.fr) : id;
        }

        // --- AUTHENTICATION ---
        window.toggleSignup = () => {
            isSignupMode = !isSignupMode;
            q('#signup-fields').classList.toggle('hidden');
            q('#btn-do-login').classList.toggle('hidden');
            q('#btn-do-signup').innerText = isSignupMode ? (currentLang==='ar'?'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¢Ù†':'CrÃ©er le compte') : (currentLang==='ar'?'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯':'CrÃ©er un nouveau compte');
            q('.t-login-title').innerText = isSignupMode ? (currentLang==='ar'?'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨':'CrÃ©er un compte') : (currentLang==='ar'?'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„':'Connexion');
        };

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            const t = translations;
            if (user) {
                q('.t-login').innerText = user.email.split('@');
                q('#logout-li').classList.remove('hidden');
                q('#msg-icon').classList.remove('hidden');
                // Fetch user doc
                const snap = await getDoc(doc(db, "users", user.uid));
                if(snap.exists()) {
                    currentUserData = snap.data();
                    if(currentUserData.banned) {
                        alert(currentLang==='ar'?"Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø­Ø¸ÙˆØ±!":"Compte banni!");
                        signOut(auth);
                    }
                }
            } else {
                q('.t-login').innerText = t.login;
                q('#logout-li').classList.add('hidden');
                q('#msg-icon').classList.add('hidden');
                currentUserData = null;
            }
        });

        window.handleLogin = async () => {
            const em = q('#auth-email').value;
            const pw = q('#auth-password').value;
            try { await signInWithEmailAndPassword(auth, em, pw); closeModal('login-modal'); } 
            catch (e) { alert("Error: " + e.message); }
        };

        window.handleSignup = async () => {
            if(!isSignupMode) return;
            const name = q('#auth-name').value;
            const phone = q('#auth-phone').value;
            const em = q('#auth-email').value;
            const pw = q('#auth-password').value;
            if(!name || !phone) { alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"); return; }
            try { 
                const cred = await createUserWithEmailAndPassword(auth, em, pw);
                await setDoc(doc(db, "users", cred.user.uid), { name, phone, email: em, posts: 0, banned: false, createdAt: serverTimestamp() });
                closeModal('login-modal'); toggleSignup();
            } catch (e) { alert("Error: " + e.message); }
        };
        // bind signup button dynamically
        q('#btn-do-signup').onclick = () => { if(isSignupMode) handleSignup(); else toggleSignup(); };

        window.logout = () => { signOut(auth); q('#sidebar').classList.remove('active'); };

        window.checkAuthAndPublish = () => {
            if(!currentUser) { openModal('login-modal'); return; }
            openModal('publish-modal');
        };

        // --- AD PUBLISHING ---
        window.submitAd = async () => {
            if(!currentUser) return;
            const title = q('#pub-title').value;
            const desc = q('#pub-desc').value;
            const price = q('#pub-price').value;
            const cat = q('#pub-category').value;
            const cond = q('#pub-condition').value;
            const city = q('#pub-city').value;
            const file = q('#pub-image').files;

            if(!title || !price || !file) { alert(currentLang==='ar'?"ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„ØµÙˆØ±Ø©!":"Veuillez remplir le titre, le prix et l'image!"); return; }
            
            const btn = q('#btn-submit-ad');
            btn.innerText = "..."; btn.disabled = true;

            try {
                // Base64 Image
                const reader = new FileReader();
                reader.onloadend = async () => {
                    const base64data = reader.result;
                    const adData = {
                        title, desc, price: Number(price), category: cat, condition: cond, city,
                        image: base64data, userId: currentUser.uid, userName: currentUserData?.name || "User", 
                        userPhone: currentUserData?.phone || "", userEmail: currentUser.email,
                        createdAt: serverTimestamp(), featured: false
                    };
                    
                    await addDoc(collection(db, "ads"), adData);
                    // Update user posts count
                    if(currentUserData) {
                        await updateDoc(doc(db, "users", currentUser.uid), { posts: (currentUserData.posts || 0) + 1 });
                    }
                    
                    closeModal('publish-modal');
                    q('#pub-title').value=''; q('#pub-desc').value=''; q('#pub-price').value=''; q('#pub-image').value='';
                    fetchAds();
                    btn.innerText = translations.publish; btn.disabled = false;
                };
                reader.readAsDataURL(file);
            } catch (e) { alert("Error: " + e.message); btn.innerText = translations.publish; btn.disabled = false; }
        };

        // --- FETCH & DISPLAY ADS ---
        async function fetchAds() {
            q('#loader-featured').style.display = 'block';
            q('#loader-latest').style.display = 'block';
            try {
                const qSnap = await getDocs(query(collection(db, "ads"), orderBy("createdAt", "desc")));
                allAds =[];
                qSnap.forEach(doc => { allAds.push({ id: doc.id, ...doc.data() }); });
                renderAdsList();
                recordVisit();
            } catch (e) { console.error("Error fetching ads:", e); }
            q('#loader-featured').style.display = 'none';
            q('#loader-latest').style.display = 'none';
        }

        function renderAdsList(ads = allAds) {
            const fGrid = q('#featured-ads-grid');
            const lGrid = q('#latest-ads-grid');
            fGrid.innerHTML = ''; lGrid.innerHTML = '';
            const t = translations;

            ads.forEach(ad => {
                const card = document.createElement('div');
                card.className = `ad-card ${ad.featured ? 'ad-featured' : ''}`;
                card.onclick = () => openAdDetail(ad);
                
                let featuredHTML = ad.featured ? `<div class="featured-badge"><i class="fa-solid fa-star"></i></div>` : '';

                card.innerHTML = `
                    ${featuredHTML}
                    <img src="${ad.image}" class="ad-img" alt="${ad.title}">
                    <div class="ad-content">
                        <div class="ad-title">${ad.title}</div>
                        <div class="ad-price">${ad.price} ${t.currency}</div>
                        <div class="ad-meta">
                            <span><i class="fa-solid fa-location-dot"></i> ${getCityName(ad.city)}</span>
                        </div>
                    </div>
                `;
                if(ad.featured) fGrid.appendChild(card);
                else lGrid.appendChild(card);
            });
            
            if(fGrid.innerHTML === '') fGrid.innerHTML = `<p style="color:#888;">${currentLang==='ar'?'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ù…ÙŠØ²Ø©.':'Aucune annonce Ã  la une.'}</p>`;
            if(lGrid.innerHTML === '') lGrid.innerHTML = `<p style="color:#888;">${currentLang==='ar'?'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª.':'Aucune annonce.'}</p>`;
        }

        window.applyFilter = () => {
            const s = q('#fil-search').value.toLowerCase();
            const c = q('#fil-category').value;
            const city = q('#fil-city').value;
            const maxP = q('#fil-price').value;
            
            const filtered = allAds.filter(ad => {
                const mS = s === '' || ad.title.toLowerCase().includes(s) || ad.desc.toLowerCase().includes(s);
                const mC = c === '' || ad.category === c;
                const mCity = city === '' || ad.city === city;
                const mPrice = maxP === '' || ad.price <= Number(maxP);
                return mS && mC && mCity && mPrice;
            });
            renderAdsList(filtered);
            closeModal('filter-modal');
            window.scrollTo({top: q('.ads-section').offsetTop - 100, behavior: 'smooth'});
        };

        // --- AD DETAILS ---
        window.openAdDetail = (ad) => {
            q('#det-img').src = ad.image;
            q('#det-title').innerText = ad.title;
            q('#det-price').innerText = `${ad.price} ${translations.currency}`;
            q('#det-city').innerHTML = `<i class="fa-solid fa-location-dot"></i> ${getCityName(ad.city)}`;
            q('#det-user').innerHTML = `<i class="fa-solid fa-user"></i> ${ad.userName || 'User'}`;
            q('#det-desc').innerText = ad.desc || (currentLang==='ar'?'Ø¨Ø¯ÙˆÙ† ÙˆØµÙ':'Pas de description');
            
            const condEl = q('#det-condition');
            if(ad.condition === 'none') {
                condEl.style.display = 'none';
            } else {
                condEl.style.display = 'inline-block';
                condEl.innerText = ad.condition === 'new' ? translations.condNew : translations.condUsed;
            }
            
            // store ad author info in global to use in buttons
            q('#phone-text').dataset.phone = ad.userPhone || '0000000000';
            q('#phone-text').innerText = translations.call;
            
            q('#ad-detail-page').classList.add('active');
            document.body.style.overflow = 'hidden'; // prevent bg scroll
        };

        window.closeAdDetail = () => {
            q('#ad-detail-page').classList.remove('active');
            document.body.style.overflow = 'auto';
        };

        window.showPhone = () => {
            if(!currentUser) { openModal('login-modal'); return; }
            q('#phone-text').innerText = q('#phone-text').dataset.phone;
        };

        window.initiateMessage = () => {
            if(!currentUser) { openModal('login-modal'); return; }
            alert(currentLang === 'ar' ? "ØªÙ… ÙØªØ­ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„! (Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø§Ù„Ùƒ)" : "Messagerie ouverte !");
        };

        // --- DYNAMIC PAGES & REPORTS ---
        window.openPage = (type) => {
            toggleSidebar();
            q('#page-title').innerText = translations;
            q('#page-content').innerText = siteSettings.pages || "...";
            openModal('page-modal');
        };

        window.submitReport = async () => {
            const name = q('#rep-name').value;
            const email = q('#rep-email').value;
            const desc = q('#rep-desc').value;
            if(!desc) return;
            await addDoc(collection(db, "reports"), { name, email, desc, createdAt: serverTimestamp() });
            alert(currentLang==='ar'?"ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­!":"EnvoyÃ© avec succÃ¨s!");
            closeModal('report-modal');
            q('#rep-desc').value='';
        };

        // --- SITE SETTINGS SYNC ---
        function listenToSettings() {
            onSnapshot(doc(db, "system", "settings"), (docSnap) => {
                if(docSnap.exists()) {
                    siteSettings = docSnap.data();
                    if(siteSettings.bannerUrl) q('#main-banner-img').src = siteSettings.bannerUrl;
                    if(siteSettings.adsHtml) q('#injected-ads').innerHTML = siteSettings.adsHtml;
                    if(siteSettings.logoText) q('#site-name').innerText = siteSettings.logoText;
                    if(siteSettings.logoImg) {
                        q('#site-logo').innerHTML = `<img src="${siteSettings.logoImg}" alt="Logo"> <span id="site-name">${siteSettings.logoText||''}</span>`;
                    }
                }
            });
        }

        // --- ADMIN PANEL ---
        window.promptAdmin = () => {
            const u = prompt("Admin User:");
            const p = prompt("Password:");
            if(u === 'admin' && p === 'abobob123') {
                q('#admin-panel').style.display = 'block';
                loadAdminData();
            } else { if(u!=null) alert("Access Denied"); }
        };

        window.exitAdmin = () => { q('#admin-panel').style.display = 'none'; };

        async function loadAdminData() {
            q('#st-ads').innerText = allAds.length;
            
            // Visits
            let visits = parseInt(localStorage.getItem('sys_visits') || "154");
            q('#st-daily').innerText = visits;
            q('#st-monthly').innerText = visits * 18;

            // Users
            const uSnap = await getDocs(collection(db, "users"));
            allUsers =
